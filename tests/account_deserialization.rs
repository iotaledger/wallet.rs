// Copyright 2023 IOTA Stiftung
// SPDX-License-Identifier: Apache-2.0

use iota_wallet::{account::Account, Result};

#[test]
fn account_deserialization() -> Result<()> {
    // An account serialized before inputs were added to the transaction object
    let account_str = r#"{"index":0,"coinType":4219,"alias":"Alice","publicAddresses":[{"address":"rms1qq34prn5jgnmer7v6veqk7yfrs8hj05a6u97yrrk4jmycdkuc3nqq2f8d2a","keyIndex":0,"internal":false,"used":true}],"internalAddresses":[],"addressesWithUnspentOutputs":[{"address":"rms1qq34prn5jgnmer7v6veqk7yfrs8hj05a6u97yrrk4jmycdkuc3nqq2f8d2a","keyIndex":0,"internal":false,"outputIds":["0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000"]}],"outputs":{"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000":{"outputId":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000","metadata":{"blockId":"0x488a085dd194ce3c2958a2013036f46811c6b7a9895719ecd5ba1d793f14c442","transactionId":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a","outputIndex":0,"isSpent":false,"milestoneIndexBooked":3060013,"milestoneTimestampBooked":1673436369,"ledgerIndex":3060016},"output":{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},"isSpent":false,"address":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"},"networkId":8342982141227064571,"remainder":false,"chain":[{"hardened":true,"bs":[128,0,0,44]},{"hardened":true,"bs":[128,0,16,123]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]}]}},"lockedOutputs":["0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000"],"unspentOutputs":{"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000":{"outputId":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000","metadata":{"blockId":"0x488a085dd194ce3c2958a2013036f46811c6b7a9895719ecd5ba1d793f14c442","transactionId":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a","outputIndex":0,"isSpent":false,"milestoneIndexBooked":3060013,"milestoneTimestampBooked":1673436369,"ledgerIndex":3060016},"output":{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},"isSpent":false,"address":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"},"networkId":8342982141227064571,"remainder":false,"chain":[{"hardened":true,"bs":[128,0,0,44]},{"hardened":true,"bs":[128,0,16,123]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]}]}},"transactions":{"0xc1e1d5f1cbd3bba6bebd1cff632e20ec49af6aa624682a8c4016b100b572b73f":{"payload":{"essence":{"type":"Regular","data":{"network_id":8342982141227064571,"inputs":{"inner":[{"type":"Utxo","data":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a0000"}],"bounded":null},"inputs_commitment":[105,31,96,2,220,51,72,68,97,106,155,242,141,139,250,66,88,32,232,237,161,151,144,122,21,211,228,136,142,219,26,19],"outputs":{"inner":[{"type":"Basic","data":{"amount":1000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x60200bad8137a704216e84f8f9acfe65b972d9f4155becb4815282b03cef99fe"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},{"type":"Basic","data":{"amount":999000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"}}],"bounded":null},"features":{"inner":[],"bounded":null}}}],"bounded":null},"payload":null}},"unlocks":{"inner":[{"type":"Signature","data":{"type":"Ed25519","data":{"public_key":[209,241,31,127,125,225,222,3,123,236,45,211,214,115,109,189,109,12,220,122,4,6,157,197,33,22,152,134,100,240,168,46],"signature":[221,128,3,215,197,167,40,226,96,58,36,172,109,98,143,156,115,170,180,164,168,64,100,55,253,204,240,37,132,217,95,10,139,98,38,56,25,245,206,174,188,155,179,26,165,213,13,120,113,79,157,21,251,91,127,22,87,127,181,193,14,54,55,3]}}}],"bounded":null}},"blockId":"0xb797a914cd5ddb2dca5a6411a356fba3d827312a8f04579a10949c9ee2b3b048","inclusionState":"Pending","timestamp":1673436841595,"transactionId":"0xc1e1d5f1cbd3bba6bebd1cff632e20ec49af6aa624682a8c4016b100b572b73f","networkId":8342982141227064571,"incoming":false,"note":null}},"pendingTransactions":["0xc1e1d5f1cbd3bba6bebd1cff632e20ec49af6aa624682a8c4016b100b572b73f"],"incomingTransactions":{"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a":[{"essence":{"type":"Regular","data":{"network_id":8342982141227064571,"inputs":{"inner":[{"type":"Utxo","data":"0xe6a0284bbababb3adeb32262abacd47e8bea1f786b799232596cae24835dc99b0100"}],"bounded":null},"inputs_commitment":[201,63,5,56,79,13,39,178,180,143,58,52,107,57,235,65,129,175,233,75,31,184,188,218,128,97,229,145,73,176,115,180],"outputs":{"inner":[{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x23508e749227bc8fccd3320b78891c0f793e9dd70be20c76acb64c36dcc46600"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},{"type":"Basic","data":{"amount":1378058476983092,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x77c2f4cdd686cc9e7667ff66977fc9e7687866a3a97745917cf786ba13a4124c"}}],"bounded":null},"features":{"inner":[],"bounded":null}}}],"bounded":null},"payload":{"type":"TaggedData","data":{"tag":{"inner":[72,79,82,78,69,84,32,70,65,85,67,69,84],"bounded":null},"data":{"inner":[],"bounded":null}}}}},"unlocks":{"inner":[{"type":"Signature","data":{"type":"Ed25519","data":{"public_key":[186,229,134,70,92,87,79,204,147,57,238,11,170,227,43,186,190,222,127,171,135,185,79,21,12,107,211,138,253,118,171,190],"signature":[70,152,179,141,1,210,7,88,192,17,125,229,124,144,205,58,121,37,123,46,216,22,234,13,148,225,185,133,25,215,178,113,201,180,15,255,64,42,127,26,23,225,219,7,179,225,47,56,211,114,24,217,253,116,133,1,111,197,236,157,28,90,167,13]}}}],"bounded":null}},[{"metadata":{"blockId":"0xae275dc58cd69d9b969115d6e2edf0a29c9580d58606160faad5cef3d3c3ea20","transactionId":"0xe6a0284bbababb3adeb32262abacd47e8bea1f786b799232596cae24835dc99b","outputIndex":1,"isSpent":true,"milestoneIndexSpent":3060013,"milestoneTimestampSpent":1673436369,"transactionIdSpent":"0x131fc4cb8f315ae36ae3bf6a4e4b3486d5f17581288f1217410da3e0700d195a","milestoneIndexBooked":3059992,"milestoneTimestampBooked":1673436264,"ledgerIndex":3060016},"output":{"type":3,"amount":"1378059476983092","unlockConditions":[{"type":0,"address":{"type":0,"pubKeyHash":"0x77c2f4cdd686cc9e7667ff66977fc9e7687866a3a97745917cf786ba13a4124c"}}]}}]]},"nativeTokenFoundries":{}}"#;
    let _account = serde_json::from_str::<Account>(account_str)?;
    // Another account serialized after inputs were added to the transaction object
    let account_str = r#"{"index":0,"coinType":4219,"alias":"Alice","publicAddresses":[{"address":"rms1qzz8m6d6cund3s5lhhc4gwnl05lx8jyqrjnfdrtje2hgkqnkjdmvv2c4enq","keyIndex":0,"internal":false,"used":true}],"internalAddresses":[],"addressesWithUnspentOutputs":[{"address":"rms1qzz8m6d6cund3s5lhhc4gwnl05lx8jyqrjnfdrtje2hgkqnkjdmvv2c4enq","keyIndex":0,"internal":false,"outputIds":["0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb230000"]}],"outputs":{"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb230000":{"outputId":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb230000","metadata":{"blockId":"0x0696a9b00293a1a71ee7d9d48235dcfab6f99e6cfcc82b068cf91f2424082ac0","transactionId":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb23","outputIndex":0,"isSpent":false,"milestoneIndexBooked":3060181,"milestoneTimestampBooked":1673437209,"ledgerIndex":3060361},"output":{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x847de9bac726d8c29fbdf1543a7f7d3e63c8801ca6968d72caae8b02769376c6"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},"isSpent":false,"address":{"type":"Ed25519","data":"0x847de9bac726d8c29fbdf1543a7f7d3e63c8801ca6968d72caae8b02769376c6"},"networkId":8342982141227064571,"remainder":false,"chain":[{"hardened":true,"bs":[128,0,0,44]},{"hardened":true,"bs":[128,0,16,123]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]}]}},"lockedOutputs":[],"unspentOutputs":{"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb230000":{"outputId":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb230000","metadata":{"blockId":"0x0696a9b00293a1a71ee7d9d48235dcfab6f99e6cfcc82b068cf91f2424082ac0","transactionId":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb23","outputIndex":0,"isSpent":false,"milestoneIndexBooked":3060181,"milestoneTimestampBooked":1673437209,"ledgerIndex":3060361},"output":{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x847de9bac726d8c29fbdf1543a7f7d3e63c8801ca6968d72caae8b02769376c6"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},"isSpent":false,"address":{"type":"Ed25519","data":"0x847de9bac726d8c29fbdf1543a7f7d3e63c8801ca6968d72caae8b02769376c6"},"networkId":8342982141227064571,"remainder":false,"chain":[{"hardened":true,"bs":[128,0,0,44]},{"hardened":true,"bs":[128,0,16,123]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]},{"hardened":true,"bs":[128,0,0,0]}]}},"transactions":{},"pendingTransactions":[],"incomingTransactions":{"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb23":{"payload":{"essence":{"type":"Regular","data":{"network_id":8342982141227064571,"inputs":{"inner":[{"type":"Utxo","data":"0x7d52d4daa261dea1a3729a7413863ff05e9a21a03b3a1bf0eb34b121886cfbc50100"}],"bounded":null},"inputs_commitment":[162,177,216,253,163,29,161,221,106,244,171,111,28,156,85,226,206,171,164,240,176,122,31,166,151,172,236,240,28,170,151,137],"outputs":{"inner":[{"type":"Basic","data":{"amount":1000000000,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x847de9bac726d8c29fbdf1543a7f7d3e63c8801ca6968d72caae8b02769376c6"}}],"bounded":null},"features":{"inner":[],"bounded":null}}},{"type":"Basic","data":{"amount":1378043476983092,"native_tokens":{"inner":[],"bounded":null},"unlock_conditions":{"inner":[{"type":"Address","data":{"type":"Ed25519","data":"0x77c2f4cdd686cc9e7667ff66977fc9e7687866a3a97745917cf786ba13a4124c"}}],"bounded":null},"features":{"inner":[],"bounded":null}}}],"bounded":null},"payload":{"type":"TaggedData","data":{"tag":{"inner":[72,79,82,78,69,84,32,70,65,85,67,69,84],"bounded":null},"data":{"inner":[],"bounded":null}}}}},"unlocks":{"inner":[{"type":"Signature","data":{"type":"Ed25519","data":{"public_key":[186,229,134,70,92,87,79,204,147,57,238,11,170,227,43,186,190,222,127,171,135,185,79,21,12,107,211,138,253,118,171,190],"signature":[5,207,55,183,48,32,56,182,117,135,36,110,136,103,137,133,21,73,16,14,167,73,65,181,149,42,115,181,151,34,255,169,128,139,223,156,187,43,15,85,224,94,235,237,232,96,13,183,24,0,64,145,196,220,40,252,201,88,105,251,156,53,40,15]}}}],"bounded":null}},"blockId":"0x2ef00333f437080c7e45d2e086b276a2d7f86d99b14c9af6c96bd9c92fbb3a22","inclusionState":"Confirmed","timestamp":1673437209000,"transactionId":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb23","networkId":8342982141227064571,"incoming":true,"note":null,"inputs":[{"metadata":{"blockId":"0x2ef00333f437080c7e45d2e086b276a2d7f86d99b14c9af6c96bd9c92fbb3a22","transactionId":"0x7d52d4daa261dea1a3729a7413863ff05e9a21a03b3a1bf0eb34b121886cfbc5","outputIndex":1,"isSpent":true,"milestoneIndexSpent":3060181,"milestoneTimestampSpent":1673437209,"transactionIdSpent":"0x8c3e7552bd6173583c446e13f4e925d4a1e94aabce0039a6835cc72f2930bb23","milestoneIndexBooked":3060148,"milestoneTimestampBooked":1673437044,"ledgerIndex":3060361},"output":{"type":3,"amount":"1378044476983092","unlockConditions":[{"type":0,"address":{"type":0,"pubKeyHash":"0x77c2f4cdd686cc9e7667ff66977fc9e7687866a3a97745917cf786ba13a4124c"}}]}}]}},"nativeTokenFoundries":{}}"#;
    let _account = serde_json::from_str::<Account>(account_str)?;

    Ok(())
}
